name: Auto Post to X (Twitter)

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  auto-post:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.COMMIT_TOKEN }}

      - name: Check queue status
        run: |
          if [ -f queue.json ]; then
            echo "ğŸ“‹ ê¸°ì¡´ í íŒŒì¼ ë°œê²¬!"
            echo "ğŸ“Š í˜„ì¬ í ê°œìˆ˜: $(jq length queue.json)"
          else
            echo "ğŸ“‹ í íŒŒì¼ ì—†ìŒ - ìƒˆë¡œ í¬ë¡¤ë§ ì˜ˆì •"
          fi

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.24'

      - name: Download go mod
        run: go mod download

      - name: Install Chrome and dependencies
        run: |
          # Chrome ì„¤ì¹˜
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          
          # ê°€ìƒ ë””ìŠ¤í”Œë ˆì´ ì„¤ì • (í•„ìš”ì‹œ)
          sudo apt-get install -y xvfb
          
          # Chrome ë²„ì „ í™•ì¸
          google-chrome --version

      - name: Execute Posting
        env:
          # X API OAuth 1.0a í† í°
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
          
          # ë‰´ìŠ¤í”½ ë¡œê·¸ì¸ ì •ë³´
          NEWSPICK_ID: ${{ secrets.NEWSPICK_ID }}
          NEWSPICK_PW: ${{ secrets.NEWSPICK_PW }}
          
          # í¬ë¡¤ë§ ì„¤ì • (GitHub Actionsì—ì„œëŠ” í•­ìƒ headless)
          HEADLESS: "1"
          DISPLAY: ":99"
        run: |
          # ê°€ìƒ ë””ìŠ¤í”Œë ˆì´ ì‹œì‘ (ë°±ê·¸ë¼ìš´ë“œ)
          Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
          
          echo "ğŸš€ ë‰´ìŠ¤ í¬ìŠ¤íŒ… ì‹œì‘..."
          go run main.go
          echo "âœ… ë‰´ìŠ¤ í¬ìŠ¤íŒ… ì™„ë£Œ!"

      - name: Commit updated queue.json
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if git diff --quiet queue.json; then
            echo "ğŸ“‹ í íŒŒì¼ì— ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
          else
            echo "ğŸ“‹ í íŒŒì¼ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤. ì»¤ë°‹í•©ë‹ˆë‹¤."
            git add queue.json
            git commit -m "ğŸ¤– Auto update queue.json after posting $(date '+%Y-%m-%d %H:%M:%S')"
            git push
          fi

      - name: Result
        run: |
          echo "ìë™ í¬ìŠ¤íŒ… ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
          echo "ì‹¤í–‰ ì‹œê°„: $(date)"
          if [ -f queue.json ]; then
            echo "ë‚¨ì€ í ê°œìˆ˜: $(jq length queue.json)"
          fi
